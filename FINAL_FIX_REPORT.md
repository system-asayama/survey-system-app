# 確率計算ツール修正レポート

## 報告日
2025-12-10

## 問題の概要

確率計算ツールで0-100点の範囲を計算すると、**46.24%**と表示されていましたが、ユーザー様の期待は**約60%**でした。

### 症状
- **確率計算ツール**: 0-100点範囲が46.24%
- **期待値**: 約60%（ハズレ20% + 実際の当たり40%）

## 原因分析

### 根本原因

`/calc_prob`エンドポイント（app.py 568-598行目）において、**ハズレ確率が考慮されていませんでした**。

実際のスピン処理（`/spin`）では：
1. まず20%の確率でハズレ判定
2. 残り80%の中で、各シンボルの確率に基づいて選択

しかし、確率計算ツール（`/calc_prob`）では：
1. ハズレを無視
2. シンボルの確率だけで計算

このため、確率計算ツールの結果が実際のスピン処理と一致しませんでした。

## 修正内容

### コード変更

**ファイル**: `app.py`  
**エンドポイント**: `/calc_prob` (568-605行目)

```python
# 修正前
cfg = _load_config()
psum = sum(float(s.prob) for s in cfg.symbols) or 100.0
for s in cfg.symbols:
    s.prob = float(s.prob) * 100.0 / psum

prob_ge = _prob_total_ge(cfg.symbols, spins, tmin)
prob_le = 1.0 if tmax is None else _prob_total_le(cfg.symbols, spins, tmax)

# 修正後
cfg = _load_config()

# ハズレ確率を考慮するため、ハズレ（0点）をシンボルリストに追加
miss_rate = cfg.miss_probability
symbols_with_miss = list(cfg.symbols)

# ハズレシンボルを追加
miss_symbol = Symbol(
    id="miss",
    label="ハズレ",
    payout_3=0.0,
    prob=miss_rate,
    color="#000000"
)
symbols_with_miss.append(miss_symbol)

# 確率を正規化（ハズレ確率 + シンボル確率の合計 = 100%）
psum = sum(float(s.prob) for s in symbols_with_miss)
for s in symbols_with_miss:
    s.prob = float(s.prob) * 100.0 / psum

prob_ge = _prob_total_ge(symbols_with_miss, spins, tmin)
prob_le = 1.0 if tmax is None else _prob_total_le(symbols_with_miss, spins, tmax)
```

### 修正のポイント

1. **ハズレシンボルを追加**: 0点、確率20%のシンボルをリストに追加
2. **確率を正規化**: ハズレ確率 + シンボル確率の合計 = 100%
3. **計算に使用**: `_prob_total_ge`と`_prob_total_le`にハズレを含むリストを渡す

## 検証結果

### 1. 確率計算ツール

```
設定:
- 最小点数: 0
- 最大点数: 100
- スピン回数: 5回

修正前: 46.24%
修正後: 59.39% ✓
```

### 2. シミュレーション（10,000回実行）

```
確率分布:
- 0-100点（ハズレ含む）: 59.64%
- 101-200点: 33.39%
- 201-300点: 5.60%

期待値:
- 理論値: 100.00点
- 実測値: 99.90点
- 誤差: -0.10% ✓
```

### 3. 確率計算ツールとシミュレーションの比較

| 項目 | 確率計算ツール | シミュレーション | 差 |
|------|---------------|-----------------|-----|
| 0-100点範囲 | 59.39% | 59.64% | +0.25% |

**結論**: 確率計算ツールと実際のスピン処理の結果が一致しています（誤差0.25%は統計的誤差の範囲内）。

## 影響範囲

### 影響を受けた機能
1. 確率計算ツール（`/calc_prob`エンドポイント）

### 影響を受けなかった機能
1. スピン処理（`/spin`エンドポイント）
2. 期待値計算（`/config`エンドポイント）
3. 景品判定
4. アンケート機能
5. 管理画面UI

## 修正履歴

### 第1回修正（コミット: 3a6da40）
- **問題**: 期待値計算のバグ（ハズレ確率が二重に適用）
- **修正**: `/config`エンドポイントの確率調整ロジックを修正
- **結果**: 期待値が80点→100点に修正

### 第2回修正（コミット: 741589e）
- **問題**: 確率計算ツールがハズレ確率を考慮していない
- **修正**: `/calc_prob`エンドポイントにハズレシンボルを追加
- **結果**: 0-100点範囲が46.24%→59.39%に修正

## 再発防止策

### 1. テストの追加
- 確率計算ツールとシミュレーションの結果を比較するテストを追加
- 期待値の誤差が5%以内であることを確認

### 2. ドキュメント整備
- 確率計算の仕組みを`probability_verification.md`に記録
- シミュレーション結果を`simulation_analysis.md`に記録

### 3. コードレビュー
- 確率計算ロジックの変更時は、必ず以下を確認：
  - ハズレ確率が正しく考慮されているか
  - 確率計算ツールとスピン処理の結果が一致するか
  - シミュレーションで検証したか

## コミット履歴

1. **3a6da40**: Fix probability calculation bug in /config endpoint
   - 期待値計算のバグを修正

2. **69f11e6**: Add simulation and demo play verification results
   - シミュレーションスクリプトを追加

3. **2e7e5e9**: Add comprehensive bug fix report
   - バグ修正レポートを追加

4. **741589e**: Fix probability calculation tool to include miss probability
   - 確率計算ツールにハズレ確率を追加

## 結論

修正は完全に成功しました。確率計算ツールと実際のスピン処理の結果が一致しています。

### 修正前
- 確率計算ツール: 46.24%
- 実際のスピン: 約60%
- 状態: ❌ 不一致

### 修正後
- 確率計算ツール: 59.39%
- 実際のスピン: 59.64%
- 状態: ✓ 一致（誤差0.25%）

---

**修正者**: Manus AI Agent  
**レビュー**: 必要  
**デプロイ**: 完了（GitHub main branch）
