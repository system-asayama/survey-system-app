# 店舗紐付け実装の進捗

## 完了した作業

### 1. データベース構造の拡張 ✅
- `T_店舗アンケート設定`テーブル作成
- `T_店舗スロット設定`テーブル作成
- `T_店舗景品設定`テーブル作成
- `T_店舗Google口コミ設定`テーブル作成
- `T_アンケート回答`に店舗ID列を追加

### 2. URLベースの店舗識別機能 ✅
- `/store/<店舗slug>/`パターンのルーティング実装
- `url_value_preprocessor`で店舗情報を自動取得
- `g.store_id`, `g.store_slug`, `g.store_name`をグローバル変数に設定
- 店舗選択ページ(`/`)の実装

### 3. 店舗ごとのアンケート・スロット機能 ✅
- アンケート送信時に店舗IDを保存
- スロット設定を店舗ごとに取得
- スロットAPIのレスポンス形式を修正（5回分のスピン結果）
- スロット動作確認完了

### 4. 動作確認 ✅
- アンケート送信: 正常動作
- 口コミ生成: 正常動作
- スロット回転: 正常動作（5回スピン、合計ポイント表示、履歴記録）

## 次のステップ

### 5. 店舗管理者用の設定画面
- [ ] アンケート設定画面（質問内容、必須項目）
- [ ] スロット設定画面（シンボル、確率、期待値）
- [ ] 景品設定画面（景品リスト、得点範囲）
- [ ] Google口コミURL設定画面
- [ ] 統計ダッシュボード（店舗ごとの集計）

### 6. 既存データのマイグレーション
- [ ] 既存のアンケート回答にデフォルト店舗IDを設定
- [ ] 既存のスロット設定を店舗設定テーブルに移行

### 7. テスト
- [ ] 複数店舗での動作確認
- [ ] 権限チェック（店舗管理者は自店舗のみ編集可能）
- [ ] 統計データの店舗別集計確認

## 技術的な課題

### 解決済み
- ✅ スロットAPIのレスポンス形式不一致
- ✅ テンプレートの`static_files`エンドポイント参照エラー
- ✅ URLルーティングの店舗slug引数の重複

### 未解決
- ⚠️ スロット履歴の日付表示（"Invalid Date"）
- ⚠️ 景品一覧の「点～」表示（店舗設定が未登録）

## URL構造

```
/                                    # 店舗選択ページ
/store/<店舗slug>/                   # 店舗トップ（現在はアンケートにリダイレクト）
/store/<店舗slug>/survey             # アンケートページ
/store/<店舗slug>/submit_survey      # アンケート送信API
/store/<店舗slug>/review_confirm     # 口コミ確認ページ
/store/<店舗slug>/slot               # スロットページ
/store/<店舗slug>/config             # スロット設定取得API
/store/<店舗slug>/spin               # スロット回転API
```

## データベーステーブル

### T_店舗アンケート設定
```sql
店舗ID, 質問1, 質問2, 質問3, 必須フラグ1, 必須フラグ2, 必須フラグ3, 作成日時, 更新日時
```

### T_店舗スロット設定
```json
{
  "店舗ID": 1,
  "設定JSON": {
    "symbols": [...],
    "reels": 3,
    "expected_value": 30
  }
}
```

### T_店舗景品設定
```sql
店舗ID, 景品名, 最小得点, 最大得点, 在庫数, 有効フラグ, 作成日時, 更新日時
```

### T_店舗Google口コミ設定
```sql
店舗ID, Google口コミURL, 作成日時, 更新日時
```
