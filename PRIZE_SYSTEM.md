# 景品管理システム

## 概要

スロットゲームの結果に基づいて、ユーザーに景品を表示する機能です。管理者は管理画面で景品を自由に設定でき、「ハズレなし」モードにも対応しています。

## 機能

### 1. 景品設定（管理画面）

管理画面の「設定」ページで景品を管理できます。

**設定項目**：
- **最低点数**: この点数以上で当選する景品の閾値
- **等級名**: 景品の等級（例: 1等、2等、参加賞）
- **景品名**: 実際の景品の内容（例: ランチ無料券、ドリンク1杯無料）

**操作**：
- **景品を追加**: 「+ 景品を追加」ボタンで新しい景品を追加
- **景品を削除**: 各景品の「削除」ボタンで削除
- **景品を編集**: 各フィールドを直接編集
- **保存**: 「保存」ボタンで変更を保存

### 2. デフォルト景品設定

初期状態では以下の5つの景品が設定されています：

| 最低点数 | 等級名 | 景品名 |
|---------|--------|--------|
| 500 | 1等 | ランチ無料券 |
| 100 | 2等 | ドリンク1杯無料 |
| 50 | 3等 | デザート50円引き |
| 20 | 4等 | 次回5%オフ |
| 0 | 参加賞 | ご参加ありがとうございました |

### 3. 景品判定ロジック

スロットで5回スピンした後、合計点数に基づいて景品が判定されます。

**判定方法**：
1. 合計点数を計算
2. 景品リストを点数の高い順に確認
3. 合計点数が「最低点数」以上の最初の景品を選択
4. 該当する景品がない場合は景品なし

**例**：
- 222点 → 100点以上 → **2等（ドリンク1杯無料）**
- 75点 → 50点以上 → **3等（デザート50円引き）**
- 15点 → 0点以上 → **参加賞（ご参加ありがとうございました）**

### 4. 景品表示

スロット終了後、緑のバナーに景品情報が表示されます。

**表示形式**：
```
🎉 おめでとうございます！○等が当たりました！！
景品: ○○○○
```

**例**：
```
🎉 おめでとうございます！2等が当たりました！！
景品: ドリンク1杯無料
```

### 5. ハズレなしモード

0点に景品を設定することで、どんな結果でも必ず景品が当たる「ハズレなし」モードを実現できます。

**設定方法**：
1. 管理画面で「最低点数: 0」の景品を設定
2. 等級名を「参加賞」などに設定
3. 景品名を「ご参加ありがとうございました」などに設定

これにより、0点でも景品が表示されます。

## 技術仕様

### ファイル構成

```
survey-system-app/
├── app.py                      # メインアプリケーション
├── prize_logic.py              # 景品判定ロジック
├── data/
│   └── settings.json           # 景品設定を含む設定ファイル
├── templates/
│   ├── slot.html               # スロットページ
│   └── admin_settings.html     # 管理画面設定ページ
└── static/
    └── slot.js                 # スロットのJavaScriptロジック
```

### データ構造

**settings.json**:
```json
{
  "google_review_url": "",
  "survey_complete_message": "ご来店ありがとうございます！...",
  "prizes": [
    {
      "min_score": 500,
      "rank": "1等",
      "name": "ランチ無料券"
    },
    {
      "min_score": 100,
      "rank": "2等",
      "name": "ドリンク1杯無料"
    }
  ]
}
```

### API エンドポイント

**POST /spin**

スロットを5回スピンして結果を返します。

**レスポンス**:
```json
{
  "ok": true,
  "spins": [
    {"id": "seven", "label": "７", "color": "#ff0000", "payout": 100},
    ...
  ],
  "total_payout": 222,
  "expected_total_5": 2500,
  "ts": 1733788213,
  "prize": {
    "rank": "2等",
    "name": "ドリンク1杯無料"
  }
}
```

### 景品判定関数

**prize_logic.py**:
```python
def get_prize_for_score(score, settings_path="data/settings.json"):
    """
    スロットの点数に応じた景品を判定する
    
    Args:
        score: スロットの合計点数
        settings_path: 設定ファイルのパス
    
    Returns:
        dict: {"rank": "1等", "name": "ランチ無料券"} または None
    """
```

## 使用方法

### 管理者向け

1. 管理画面にログイン
2. 「設定」ページに移動
3. 「景品管理」セクションで景品を編集
4. 「保存」ボタンをクリック

### ユーザー向け

1. アンケートに回答
2. スロットをプレイ
3. 結果に応じて景品が表示される
4. 景品情報を店舗スタッフに提示

## トラブルシューティング

### 景品が表示されない

**原因**: 景品設定が空の場合
**解決策**: 管理画面で少なくとも1つの景品を設定してください

### 景品が間違って表示される

**原因**: 景品の「最低点数」が正しく設定されていない
**解決策**: 景品リストを点数の高い順に並べ替えて確認してください

### 保存ボタンを押しても反映されない

**原因**: ブラウザのキャッシュまたはサーバーの再起動が必要
**解決策**: 
1. ブラウザをリロード（Ctrl+F5）
2. Flaskサーバーを再起動

## 今後の拡張案

- [ ] 景品の当選確率を設定
- [ ] 景品の在庫管理
- [ ] 景品の有効期限設定
- [ ] 景品の利用履歴追跡
- [ ] QRコードでの景品引換機能
