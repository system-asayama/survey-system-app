# スロット確率設定機能

## 概要

管理画面からスロットのシンボル、配当、確率を自由に設定できる機能です。管理者は、ビジネスニーズに応じてスロットの期待値や当選確率を調整できます。

## 機能

### 1. スロット確率設定（管理画面）

管理画面の「設定」ページに「🎰 スロット確率設定」セクションがあります。

**設定項目**：
- **5回スピンの期待値**: スロットを5回スピンしたときの平均合計点数
- **シンボル設定**（各シンボルごと）:
  - **ID**: シンボルの識別子（例: seven, bar, bell）
  - **表示**: スロットに表示される文字（例: ７, BAR, 🔔）
  - **配当**: 3つ揃ったときの点数（例: 100, 50, 20）
  - **確率(%)**: シンボルが出現する確率（例: 2.0394, 4.0789）
  - **色**: シンボルの色（カラーピッカーで選択）

**操作**：
- **シンボルを追加**: 「+ シンボルを追加」ボタンで新しいシンボルを追加
- **シンボルを削除**: 各シンボルの「削除」ボタンで削除
- **シンボルを編集**: 各フィールドを直接編集
- **確率を自動調整**: 「確率を自動調整」ボタンで配当に基づいて確率を自動計算
- **保存**: 「スロット設定を保存」ボタンで変更を保存

### 2. デフォルトシンボル設定

初期状態では以下の7つのシンボルが設定されています：

| ID | 表示 | 配当 | 確率(%) | 色 |
|---|---|---|---|---|
| GOD | GOD | 500 | 0.4079 | 🟠 オレンジ |
| seven | ７ | 100 | 2.0394 | 🔴 赤 |
| bar | BAR | 50 | 4.0789 | 🔵 青 |
| bell | 🔔 | 20 | 10.1971 | 🟤 茶 |
| grape | 🍇 | 12 | 16.9952 | 🟣 紫 |
| cherry | 🍒 | 8 | 25.4929 | 🔴 赤 |
| lemon | 🍋 | 5 | 40.7886 | 🟡 黄 |

### 3. 確率自動調整機能

「確率を自動調整」ボタンをクリックすると、配当に基づいて確率が自動的に計算されます。

**計算方法**：
1. 各シンボルの配当の逆数を計算（配当が高いほど確率が低い）
2. 逆数の合計で正規化して100%になるように調整
3. 各シンボルの確率を更新

**例**：
- 配当500 → 逆数 1/500 = 0.002 → 確率 0.4079%
- 配当5 → 逆数 1/5 = 0.2 → 確率 40.7886%

この方法により、高配当のシンボルは低確率、低配当のシンボルは高確率になります。

### 4. 期待値の設定

「5回スピンの期待値」フィールドで、スロットの期待値を設定できます。

**期待値とは**：
- スロットを5回スピンしたときに獲得できる平均点数
- 高い期待値 → ユーザーが高得点を獲得しやすい → 高価な景品が当たりやすい
- 低い期待値 → ユーザーが低得点になりやすい → 低価な景品が当たりやすい

**推奨値**：
- **100点**: バランスの取れた設定（デフォルト）
- **50点**: 厳しめの設定（高価な景品を出したくない場合）
- **150点**: 甘めの設定（ユーザーに高価な景品を提供したい場合）

## 使用方法

### 管理者向け

#### 1. 確率を手動で調整する

1. 管理画面にログイン
2. 「設定」ページに移動
3. 「🎰 スロット確率設定」セクションまでスクロール
4. 各シンボルの「確率(%)」フィールドを編集
5. 「スロット設定を保存」ボタンをクリック

#### 2. 確率を自動調整する

1. 管理画面にログイン
2. 「設定」ページに移動
3. 「🎰 スロット確率設定」セクションまでスクロール
4. 各シンボルの「配当」を設定
5. 「確率を自動調整」ボタンをクリック
6. 確率が自動的に計算される
7. 「スロット設定を保存」ボタンをクリック

#### 3. 新しいシンボルを追加する

1. 管理画面にログイン
2. 「設定」ページに移動
3. 「🎰 スロット確率設定」セクションまでスクロール
4. 「+ シンボルを追加」ボタンをクリック
5. 新しい行が追加される
6. ID、表示、配当、確率、色を設定
7. 「スロット設定を保存」ボタンをクリック

#### 4. シンボルを削除する

1. 管理画面にログイン
2. 「設定」ページに移動
3. 「🎰 スロット確率設定」セクションまでスクロール
4. 削除したいシンボルの「削除」ボタンをクリック
5. 「スロット設定を保存」ボタンをクリック

### ユーザー向け

ユーザーは設定を変更できません。管理者が設定した確率に基づいてスロットが動作します。

## 技術仕様

### ファイル構成

```
survey-system-app/
├── app.py                      # メインアプリケーション
├── data/
│   └── config.json             # スロット設定ファイル
└── templates/
    └── admin_settings.html     # 管理画面設定ページ
```

### データ構造

**config.json**:
```json
{
  "symbols": [
    {
      "id": "seven",
      "label": "７",
      "payout_3": 100.0,
      "color": "#f50a39",
      "prob": 2.0394
    },
    {
      "id": "lemon",
      "label": "🍋",
      "payout_3": 5.0,
      "color": "#fde047",
      "prob": 40.7886
    }
  ],
  "reels": 3,
  "base_bet": 1,
  "expected_total_5": 100.0
}
```

### API エンドポイント

**POST /admin/save_slot_config**

スロット設定を保存します。

**リクエスト（フォームデータ）**:
```
expected_total_5: 100.0
symbol_count: 7
symbol_id_0: seven
symbol_label_0: ７
symbol_payout_0: 100
symbol_prob_0: 2.0394
symbol_color_0: #f50a39
...
```

**レスポンス**:
- 成功: 設定ページにリダイレクト + 成功メッセージ
- 失敗: 設定ページにリダイレクト + エラーメッセージ

### JavaScript関数

**addSlotSymbol()**

新しいシンボル行を追加します。

```javascript
function addSlotSymbol() {
  const tbody = document.getElementById('slot-symbols');
  const count = tbody.querySelectorAll('tr').length;
  // 新しい行を作成して追加
}
```

**removeSlotSymbol(btn)**

シンボル行を削除します。

```javascript
function removeSlotSymbol(btn) {
  const row = btn.closest('tr');
  row.remove();
  // シンボル数を更新
}
```

**autoAdjustProb()**

配当に基づいて確率を自動調整します。

```javascript
function autoAdjustProb() {
  // 各シンボルの配当を取得
  // 逆比例で確率を計算
  // 確率フィールドを更新
}
```

## ベストプラクティス

### 1. 確率の合計は100%にする

確率を手動で設定する場合、すべてのシンボルの確率の合計が100%になるようにしてください。

**例**：
- シンボルA: 30%
- シンボルB: 40%
- シンボルC: 30%
- **合計: 100%** ✓

### 2. 高配当シンボルは低確率にする

高配当のシンボル（例: GOD 500点）は低確率（例: 0.4%）に設定することで、バランスの取れたゲームになります。

### 3. 期待値と景品設定を連動させる

期待値を高く設定した場合、景品の最低点数も高めに設定してください。

**例**：
- 期待値: 150点
- 1等: 500点以上
- 2等: 200点以上（100点ではなく）

### 4. 定期的にテストする

設定を変更したら、必ずスロットをプレイしてテストしてください。

## トラブルシューティング

### 確率が反映されない

**原因**: ブラウザのキャッシュまたはサーバーの再起動が必要  
**解決策**: 
1. ブラウザをリロード（Ctrl+F5）
2. Flaskサーバーを再起動

### 確率の合計が100%にならない

**原因**: 手動で確率を設定した際に合計が100%を超えた、または不足している  
**解決策**: 「確率を自動調整」ボタンをクリックして自動計算

### シンボルが表示されない

**原因**: シンボルのIDまたはラベルが空白  
**解決策**: すべてのシンボルにIDとラベルを設定してください

### 保存ボタンを押してもエラーが出る

**原因**: 無効なデータ（例: 負の配当、101%を超える確率）  
**解決策**: 
1. 配当は0以上の数値
2. 確率は0〜100の範囲内

## 今後の拡張案

- [ ] 確率の合計が100%になるように自動調整
- [ ] 期待値に基づく確率の自動計算
- [ ] シンボルのプレビュー機能
- [ ] 確率のシミュレーション機能
- [ ] 複数のスロット設定プリセット
