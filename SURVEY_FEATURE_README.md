# アンケート機能実装ドキュメント

## 概要

スロットアプリにGoogle Mapのお店アンケートと親和性の高いアンケート機能を追加しました。アンケート回答後、AIが自動で口コミ投稿文を生成し、星評価に応じてGoogle口コミへの投稿誘導または内部保存を行います。

## 実装された機能

### 1. アンケート機能

Google Mapのお店アンケートと同様の以下の項目を実装：

- **星評価（5段階）**: お店の総合評価
- **訪問目的**: 食事、カフェ、買い物、その他
- **お店の雰囲気**: 静か、賑やか、落ち着く、おしゃれ、カジュアル（複数選択可）
- **友人におすすめしたいですか**: ぜひおすすめしたい、おすすめしたい、どちらでもない、おすすめしない
- **ご感想・ご意見**: 自由記述欄

### 2. AI投稿文生成機能

OpenAI API（gpt-4.1-mini）を使用して、アンケート回答内容から自然な口コミ投稿文を自動生成します。

**生成される投稿文の特徴：**
- アンケート内容を元に自然な日本語の口コミ文を作成
- 星評価に応じたトーンで生成（高評価：肯定的、低評価：建設的）
- 150-200文字程度の読みやすい長さ

### 3. 星評価による分岐処理

#### 星4以上の場合：
- AI生成された投稿文を表示
- 「コピー」ボタンで投稿文をクリップボードにコピー可能
- 「Google口コミに投稿する」ボタンを表示
- Google口コミページへの誘導（新しいタブで開く）
- その後スロットページへ遷移

#### 星3以下の場合：
- AI生成された投稿文を表示（内部確認用）
- 「貴重なご意見ありがとうございます」メッセージを表示
- 内部フィードバックとして保存のみ
- 「スロットへ進む」ボタンのみ表示
- Google口コミへは誘導しない

### 4. データ保存

アンケート回答データは以下の形式でJSONファイルに保存されます：

**保存先**: `data/survey_responses.json`

**保存内容**:
```json
{
  "timestamp": "2025-12-09T00:14:06.123456",
  "rating": 5,
  "purpose": "食事",
  "atmosphere": ["静か", "落ち着く"],
  "recommend": "ぜひおすすめしたい",
  "comment": "料理がとても美味しく、スタッフの対応も素晴らしかったです。",
  "generated_review": "AI生成された投稿文...",
  "session_id": "セッションID"
}
```

## ユーザーフロー

```
1. トップページ（/）
   ↓
2. アンケートページ（/survey）
   - 星評価、訪問目的、雰囲気、おすすめ度、コメントを入力
   - 「アンケートを送信してスロットへ」ボタンをクリック
   ↓
3. 口コミ投稿確認ページ（/review_confirm）
   - AIが生成した投稿文を表示
   - 星4以上: Google口コミ投稿ボタン表示
   - 星3以下: 内部保存メッセージ表示
   ↓
4. スロットページ（/slot）
   - アンケート完了メッセージ表示
   - スロットマシンをプレイ可能
   - 「アンケートをリセット」ボタンで再度アンケート回答可能
```

## 技術仕様

### 使用技術
- **バックエンド**: Flask (Python)
- **AI**: OpenAI API (gpt-4.1-mini)
- **フロントエンド**: HTML, CSS, JavaScript
- **セッション管理**: Flask Session

### 新規追加ファイル

#### テンプレート
- `templates/survey.html` - アンケートページ
- `templates/review_confirm.html` - 口コミ投稿確認ページ

#### スタイル
- `static/survey.css` - アンケート用CSS

#### スクリプト
- `static/survey.js` - アンケート用JavaScript

#### データ保存
- `data/survey_responses.json` - アンケート回答データ

### 環境変数

以下の環境変数を設定してください：

```bash
# OpenAI API（既に設定済み）
OPENAI_API_KEY=your_api_key_here

# Google口コミURL（お店のPlace IDを設定）
GOOGLE_REVIEW_URL=https://search.google.com/local/writereview?placeid=YOUR_PLACE_ID

# セッション用シークレットキー（自動生成）
SECRET_KEY=auto_generated
```

### Google口コミURLの設定方法

1. Google Mapで対象のお店を検索
2. お店のページURLから`Place ID`を取得
3. 以下の形式でURLを作成：
   ```
   https://search.google.com/local/writereview?placeid=YOUR_PLACE_ID
   ```
4. 環境変数`GOOGLE_REVIEW_URL`に設定

**例**:
```bash
export GOOGLE_REVIEW_URL="https://search.google.com/local/writereview?placeid=ChIJN1t_tDeuEmsRUsoyG83frY4"
```

## API エンドポイント

### GET /survey
アンケートページを表示

### POST /submit_survey
アンケートデータを送信し、AI投稿文を生成

**リクエストボディ**:
```json
{
  "rating": 5,
  "purpose": "食事",
  "atmosphere": ["静か", "落ち着く"],
  "recommend": "ぜひおすすめしたい",
  "comment": "料理がとても美味しく..."
}
```

**レスポンス**:
```json
{
  "ok": true,
  "message": "アンケートを受け付けました",
  "rating": 5,
  "generated_review": "AI生成された投稿文...",
  "redirect_url": "/review_confirm"
}
```

### GET /review_confirm
口コミ投稿確認ページを表示

### POST /reset_survey
アンケートをリセットして再度回答可能にする

## 起動方法

```bash
# 依存パッケージをインストール
pip3 install -r requirements.txt

# アプリケーションを起動
python3 app.py
```

デフォルトでは `http://localhost:5000` でアクセス可能です。

## テスト結果

### 高評価テスト（星5つ）
- ✅ アンケート入力・送信成功
- ✅ AI投稿文生成成功
- ✅ Google口コミ投稿ボタン表示
- ✅ スロットページへの遷移成功

### 低評価テスト（星2つ）
- ✅ アンケート入力・送信成功
- ✅ AI投稿文生成成功（建設的なトーン）
- ✅ 内部保存メッセージ表示
- ✅ Google口コミボタン非表示
- ✅ スロットページへの遷移成功

## 今後の拡張案

1. **アンケート回答の管理画面**: 管理者が回答データを閲覧・分析できる画面
2. **統計ダッシュボード**: 星評価の分布、訪問目的の傾向などを可視化
3. **メール通知**: 低評価時に管理者へ自動通知
4. **多言語対応**: 英語など他言語でのアンケート対応
5. **カスタマイズ可能な質問項目**: 管理画面から質問内容を変更可能に

## トラブルシューティング

### OpenAI APIエラーが発生する場合
- 環境変数`OPENAI_API_KEY`が正しく設定されているか確認
- APIの利用制限に達していないか確認

### Google口コミページが開かない場合
- 環境変数`GOOGLE_REVIEW_URL`が正しく設定されているか確認
- Place IDが正しいか確認

### アンケートがリセットされない場合
- ブラウザのキャッシュをクリア
- セッションCookieを削除

## ライセンス

このプロジェクトは既存のスロットアプリに追加された機能です。

## 作成日

2025年12月9日
